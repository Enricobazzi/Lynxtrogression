---
title: "explore_ea_run_sfs"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, cache = FALSE}
require("knitr")

# set working directory
opts_knit$set(root.dir = "/Users/enrico/Documents/Lynxtrogression")
```

In this MD we analyze the results from the EA runs which are saved in the file called:

- data/demographic_inference/ea_log_sfs.csv

generated by the script:

- src/demographic_inference/print_csv_from_log_dir.py

Prepare R environment:

```{r}
# libraries:
library(tidyverse)
library(FactoMineR)
library(reshape)
```

Load the data:

```{r}
# read the data setting columns 2 to 8 as float and the 
# rest as string
df <- read.table("data/demographic_inference/ea_log_sfs.csv", 
                 sep = ",", 
                 header = T, 
                 colClasses = c(
                   rep("numeric", 9),
                   rep("character", 1)
                   )
                 )

# remove rows with NAs
df <- df %>% drop_na()

# scale the values of columns 2 to 8 to be between 0 and 1 with
# 0 being the minimum and 1 being the maximum across all columns
# df[,2:8] <- apply(df[,2:8], 2, function(x) (x - min(x)) / (max(x) - min(x)))
```

Create a PCA object using the columns you prefer:

```{r}
# run pca for columns 2 to 8
all_pca <- FactoMineR::PCA(df[,2:8], scale.unit = T, graph = F)
pca_df <- as.data.frame(all_pca$ind$coord)

# run pca for columns 2, 3, 5, 6, 7, 8
# all_pca <- FactoMineR::PCA(df[,c(2,3,5,6,7,8)], scale.unit = T, graph = F)
# pca_df <- as.data.frame(pca$ind$coord)

# add run type and fitness to the pca_df
pca_df$type <- df$type
pca_df$fitness <- df$fitness
```

Final adjustments to the table:

```{r}
# change fitness to a categorical variable where:
# - values between 0 and 4 are "low"
# - values between 4 and 8 are "medium"
# - values above 8 are"high"
pca_df$fitness <- ifelse(pca_df$fitness < 4, "low", 
                         ifelse(pca_df$fitness < 8, "medium", "high"))
```

Plot the PCA:

```{r}
# plot the pca:
# - scaling the points color by fitness (red = low, orange = medium, blue = high)
# - having a different shape for each run type
# - adding a legend at the bottom
# - adding amount of variance explained to the axis labels
ggplot(pca_df, aes(x = Dim.1, y = Dim.2, fill = fitness, shape = type)) +
  geom_point(size = 3) +
  scale_fill_manual(values = c("red", "orange", "blue")) +
  scale_shape_manual(values = c(22, 21)) +
  theme(legend.position = "right") +
  labs(x = paste0("Dim.1 (", round(all_pca$eig[1,2], 2), "%)"), 
       y = paste0("Dim.2 (", round(all_pca$eig[2,2], 2), "%)")) +
  theme_bw()
```

plot distribution of columns 2 to 8, from runs with fitness < 4

```{r}
# plot distribution of columns 2 to 8, using runs with fitness < 4
# plotting by run type
df %>% filter(fitness < 4) %>%
  gather(key = "variable", value = "value", X0_1:X2_1) %>%
  ggplot(aes(x = value, fill = type)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()
```

plot tests of three lynx pardinus individuals

```{r}
lp220 <- read.table(
  "/Users/enrico/Documents/Lynxtrogression/data/demographic_inference/testing_0220.txt", 
  sep = ",", 
  header = F,
  col.names = colnames(df),
  colClasses = c(
    rep("numeric", 9),
    rep("character", 1)
    )
)
lp220$type <- "lp220"

lp474 <- read.table(
  "/Users/enrico/Documents/Lynxtrogression/data/demographic_inference/testing_0474.txt", 
  sep = ",", 
  header = F,
  col.names = colnames(df),
  colClasses = c(
    rep("numeric", 9),
    rep("character", 1)
    )
)
lp474$type <- "lp474"

lp614 <- read.table(
  "/Users/enrico/Documents/Lynxtrogression/data/demographic_inference/testing_0614.txt", 
  sep = ",", 
  header = F,
  col.names = colnames(df),
  colClasses = c(
    rep("numeric", 9),
    rep("character", 1)
    )
)
lp614$type <- "lp614"

df_wpre <- rbind(lp220, lp474, lp614)

# plot distribution of columns 2 to 8, using runs with fitness < 4
# plotting by run type
df_wpre %>% filter(fitness < 4) %>%
  gather(key = "variable", value = "value", X0_1:X2_1) %>%
  ggplot(aes(x = value, fill = type)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()

df_wpre$summ <- df_wpre$X1_0 + df_wpre$X2_0
df_wpre %>% filter(fitness < 4) %>%
  gather(key = "variable", value = "value", summ) %>%
  ggplot(aes(x = X1_0 + X2_0, fill = type)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()


# test significance of difference between lp614, lp747 and lp220 for X1_0 and X2_0 separately and their sum
# X1_0
t.test(lp614$X1_0, lp220$X1_0)
t.test(lp614$X1_0, lp474$X1_0)
t.test(lp220$X1_0, lp474$X1_0)

# X2_0
t.test(lp614$X2_0, lp220$X2_0)
t.test(lp614$X2_0, lp474$X2_0)
t.test(lp220$X2_0, lp474$X2_0)

# X1_0 + X2_0
t.test(lp614$X1_0 + lp614$X2_0, lp220$X1_0 + lp220$X2_0)
t.test(lp614$X1_0 + lp614$X2_0, lp474$X1_0 + lp474$X2_0)
t.test(lp220$X1_0 + lp220$X2_0, lp474$X1_0 + lp474$X2_0)

t.test(lp614$X1_0 + lp614$X2_0, lp614$X0_1 + lp614$X0_2)
t.test(lp474$X1_0 + lp474$X2_0, lp474$X0_1 + lp474$X0_2)
t.test(lp220$X1_0 + lp220$X2_0, lp220$X0_1 + lp220$X0_2)

postphase <- df %>% filter(type == "observed")
postphase$X0_1 + postphase$X0_2
postphase$X1_0 + postphase$X2_0

simulated <- df %>% filter(type == "simulated")
simulated$X0_1 + simulated$X0_2
simulated$X1_0 + simulated$X2_0
```